# ЁЯЪА рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХрд╛ рдирд╛рдо (Name of the workflow)
name: ЁЯОе Video Automation and Package Build

# тЪЩя╕П рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХреЛ рдХрдм рд░рди рдХрд░рдирд╛ рд╣реИ (When to run the workflow)
on:
  # рдЬрдм master/main рдмреНрд░рд╛рдВрдЪ рдореЗрдВ рдХреЛрдб рдкреБрд╢ (push) рд╣реЛ
  push:
    branches:
      - master
      - main
  # рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
  workflow_dispatch:
    
# ЁЯЫая╕П рдЬреЙрдмреНрд╕ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░реЗрдВ (Define the jobs)
jobs:
  # рдПрдХ рдЬреЙрдм рдХрд╛ рдирд╛рдо: build_and_deploy
  build_and_deploy:
    # рдпрд╣ рдЬреЙрдм рдХрд┐рд╕ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЪрд▓реЗрдЧреА
    runs-on: ubuntu-latest
    
    # рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХрдорд┐рдЯ рд╕реНрдЯреЗрдк (git push) рдХрд╛рдо рдХрд░реЗ, рдпрд╣рд╛рдВ permissions рдЬреЛрдбрд╝реЗрдВ
    permissions:
      contents: write # git push рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ
      
    # рдЖрд╡рд╢реНрдпрдХ Secrets рдХреЛ рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдореЗрдВ рд▓реЛрдб рдХрд░реЗрдВред
    env:
      GOOGLE_SHEET_CSV_URL: ${{ secrets.GOOGLE_SHEET_CSV_URL }}
      YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
      YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
      YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 

    # ЁЯСЗя╕П рдпрд╣ рд╣реИ рдЖрдкрдХреА рд▓рд╛рдЗрди 16, рдЕрдм рдпрд╣ 'build_and_deploy' рдЬреЙрдм рдХреЗ рдЕрдВрджрд░ 2 рд╕реНрдкреЗрд╕ рдкрд░ рдЗрдВрдбреЗрдВрдЯреЗрдб рд╣реИред
    # рдпрд╣ 'env' рдХреЗ рдмрд╛рдж, рдЙрд╕реА рд▓реЗрд╡рд▓ рдкрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рддрд╛рдХрд┐ рдмрд╛рдж рдореЗрдВ git push/commit рдХрд╛рдо рдХрд░ рд╕рдХреЗ
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # Python рдХреЛ 3.11 рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
          python-version: '3.11'

      - name: Install system & Python dependencies (API & Libraries)
        run: |
          # рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ jq (JSON рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП) рдФрд░ рдЕрдиреНрдп рдЯреВрд▓ рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛрдВ
          sudo apt-get update && sudo apt-get install -y jq
          pip install --upgrade pip
          # рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдХреЛ рдПрдХ рд╕рд╛рде рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ
          pip install pandas requests google-api-python-client google-auth google-auth-oauthlib google-genai openpyxl
        shell: bash

      # 1. Main Automation Script рдЪрд▓рд╛рдПрдВ рдФрд░ JSON рдЖрдЙрдЯрдкреБрдЯ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ
      - name: Run Main Automation Script
        id: run_script
        run: |
          set -euo pipefail
          echo "Running main_automation.py..."
          # Python рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЪрд▓рд╛рдПрдБ рдФрд░ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдПрдХ JSON рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдВ
          python .github/workflows/main_automation.py "${{ env.GOOGLE_SHEET_CSV_URL }}" > script_output.json
          
          # JSON рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ
          videos=$(jq -r '.videos_generated // 0' script_output.json)
          zip=$(jq -r '.zip_path // ""' script_output.json)
          next_index=$(jq -r '.next_start_index // 1' script_output.json)
          
          echo "Parsed outputs: videos_generated=$videos, zip_path=$zip, next_start_index=$next_index"
          
          # GITHUB_OUTPUT рдХреЛ рд╕реЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЗрд╕реЗ рдЕрдЧрд▓реЗ steps рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ
          echo "videos_generated=$videos" >> $GITHUB_OUTPUT
          echo "zip_path=$zip" >> $GITHUB_OUTPUT
          echo "next_index=$next_index" >> $GITHUB_OUTPUT
        shell: bash
        
      # 2. state.txt рдХреЛ GitHub рдореЗрдВ рдХрдорд┐рдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреЗрдк
      - name: Commit State File for Next Run
        # рдпрд╣ рддрднреА рд░рди рд╣реЛ рдЬрдм рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕рдлрд▓ рд╣реЛ рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ рд╡реАрдбрд┐рдпреЛ рдкреНрд░реЛрд╕реЗрд╕ рд╣реБрдЖ рд╣реЛ
        if: success() && steps.run_script.outputs.next_start_index != '' && steps.run_script.outputs.videos_generated != '0'
        run: |
          # Git рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реЗрдЯ рдХрд░реЗрдВ
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # state.txt рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕реНрдЯреЗрдЬ рдХрд░реЗрдВ рдФрд░ рдХрдорд┐рдЯ рдХрд░реЗрдВ
          git add .github/workflows/state.txt
          # рдпрджрд┐ рдХреЛрдИ рдмрджрд▓рд╛рд╡ рдирд╣реАрдВ рд╣реИ рддреЛ рдХрдорд┐рдЯ рдлрд╝реЗрд▓ рди рд╣реЛ
          git commit -m "Automation: Updated state file to index ${{ steps.run_script.outputs.next_start_index }}" || true
          git push
        shell: bash


      # 3. рдкреНрд░реЛрдбрдХреНрд╢рди рдкреИрдХреЗрдЬ рдЖрд░реНрдЯрд┐рдлреИрдХреНрдЯ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ
      - name: Upload Production Package Artifact
        uses: actions/upload-artifact@v4
        # рдпрд╣ рддрднреА рд░рди рд╣реЛ рдЬрдм рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕рдлрд▓ рд╣реЛ рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ рд╡реАрдбрд┐рдпреЛ рдЬрдирд░реЗрдЯ рд╣реБрдЖ рд╣реЛ
        if: success() && steps.run_script.outputs.videos_generated != '0'
        with:
          # run_id рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рд╣рд░ рд░рди рдХрд╛ рдПрдХ рдпреВрдирд┐рдХ рдЖрд░реНрдЯрд┐рдлреИрдХреНрдЯ рдирд╛рдо рд╣реЛ
          name: Production-Package-${{ github.run_id }}
          # Python рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕реЗ zip_path рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
          path: ${{ steps.run_script.outputs.zip_path }}
          retention-days: 7 # 7 рджрд┐рдиреЛрдВ рдХреЗ рдмрд╛рдж рдЖрд░реНрдЯрд┐рдлреИрдХреНрдЯ рдХреЛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛
